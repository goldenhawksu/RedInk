name: Sync Upstream

on:
  schedule:
    # æ¯å‘¨æ—¥ 00:00 UTC è¿è¡Œ (åŒ—äº¬æ—¶é—´å‘¨æ—¥ 08:00)
    - cron: '0 0 * * 0'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # éœ€è¦å†™æƒé™æ¥æŽ¨é€

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/HisMax/RedInk.git || true
          git fetch upstream

      - name: Check for new commits
        id: check
        run: |
          NEW_COMMITS=$(git log HEAD..upstream/main --oneline)
          if [ -z "$NEW_COMMITS" ]; then
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "âœ… å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€åŒæ­¥"
          else
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ å‘çŽ°æ–°æäº¤:"
            echo "$NEW_COMMITS"
          fi

      - name: Merge upstream changes
        if: steps.check.outputs.has_updates == 'true'
        run: |
          git checkout main
          git merge upstream/main --no-edit

      - name: Push changes
        if: steps.check.outputs.has_updates == 'true'
        run: |
          git push origin main

      - name: Create summary
        if: steps.check.outputs.has_updates == 'true'
        run: |
          echo "## ðŸ”„ Upstream åŒæ­¥æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "å·²åŒæ­¥ä»¥ä¸‹æäº¤:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          git log HEAD~5..HEAD --oneline >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
